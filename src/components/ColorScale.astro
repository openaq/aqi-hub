---
import ColorScaleChart from "./ColorScaleChart.astro";
import { colorScaleReshape } from "../utils/utils.jsx";
import type { ColorScaleDefinition, IndexDefinition } from "src/types/types";

const { colorScaleValues, index, value } = Astro.props;

let colorScale: ColorScaleDefinition[] = [];

if (colorScaleValues) {
  colorScale = colorScaleValues;
} else if (index) {
  const res = await fetch(new URL(`/api/data/${index}.json`, Astro.url));
  const parsed = await res.json();
  let filteredContent = parsed.filter(
    (o: IndexDefinition) => o.pollutant == "PM2.5"
  );
  filteredContent = filteredContent.map((o: IndexDefinition) => {
    o.concentrationUpper ? o.concentrationUpper : (o.concentrationUpper = 500);
    return o;
  });
  colorScale = colorScaleReshape(filteredContent, value);
}
---

<ColorScaleChart colorScale={colorScale} />
